From 00ae898c53af6e3e8e7660f736c7e078547c465b Mon Sep 17 00:00:00 2001
From: Konsta <konsta09@gmail.com>
Date: Tue, 20 May 2014 17:54:58 +0300
Subject: [PATCH 5/5] run syspart fixup and reduce wifi logging

Sync audio/wifi init scripts with stock.

Change-Id: I1e0fe20986db54c4564f63c22b4a07baf2bced57
---
 rootdir/etc/init.qcom.audio.sh |   35 ++++++++++++++++++++++++++++++++++
 rootdir/etc/init.qcom.rc       |    7 ++++---
 rootdir/etc/init.qcom.wifi.sh  |   41 ++++++++++++++++------------------------
 3 files changed, 55 insertions(+), 28 deletions(-)

diff --git a/rootdir/etc/init.qcom.audio.sh b/rootdir/etc/init.qcom.audio.sh
index cbfe9ff..0b71094 100644
--- a/rootdir/etc/init.qcom.audio.sh
+++ b/rootdir/etc/init.qcom.audio.sh
@@ -115,6 +115,41 @@ case "$btsoc" in
         ;;
 esac
 
+case "$target" in
+    msm8974*)
+
+        rm -rf /system/etc/firmware/wcd9320/wcd9320_anc.bin
+        rm -rf /system/etc/firmware/wcd9320/wcd9320_mbhc.bin
+        mkdir -p /system/etc/firmware/wcd9320
+        ln -s /data/misc/audio/wcd9320_anc.bin /system/etc/firmware/wcd9320/wcd9320_anc.bin
+        ln -s /data/misc/audio/mbhc.bin /system/etc/firmware/wcd9320/wcd9320_mbhc.bin
+        ln -s /data/misc/audio/wcd9320_mad_audio.bin /system/etc/firmware/wcd9320/wcd9320_mad_audio.bin
+        ;;
+
+    msm8226*)
+
+        rm -rf /system/etc/firmware/wcd9306/wcd9306_anc.bin
+        rm -rf /system/etc/firmware/wcd9306/wcd9306_mbhc.bin
+        mkdir -p /system/etc/firmware/wcd9306
+        ln -s /data/misc/audio/wcd9320_anc.bin /system/etc/firmware/wcd9306/wcd9306_anc.bin
+        ln -s /data/misc/audio/mbhc.bin /system/etc/firmware/wcd9306/wcd9306_mbhc.bin
+        ;;
+
+    msm8960*)
+    ;&
+    msm8660*)
+
+        rm -f /system/etc/firmware/wcd9310/wcd9310_anc.bin
+        rm -f /system/etc/firmware/wcd9310/wcd9310_mbhc.bin
+        mkdir -p /system/etc/firmware/wcd9310
+        ln -s /data/misc/audio/wcd9310_anc.bin /system/etc/firmware/wcd9310/wcd9310_anc.bin
+        ln -s /data/misc/audio/mbhc.bin /system/etc/firmware/wcd9310/wcd9310_mbhc.bin
+        ;;
+
+    *)
+        ;;
+esac
+
 setprop qcom.audio.init complete
 exit 0
 
diff --git a/rootdir/etc/init.qcom.rc b/rootdir/etc/init.qcom.rc
index aad07a4..9f8598c 100644
--- a/rootdir/etc/init.qcom.rc
+++ b/rootdir/etc/init.qcom.rc
@@ -56,6 +56,7 @@ on early-boot
     setrlimit 8 67108864 67108864
     # Allow subsystem (modem etc) debugging
     write /sys/module/subsystem_restart/parameters/enable_debug ${persist.sys.ssr.enable_debug}
+    exec /system/bin/sh /init.qcom.syspart_fixup.sh ${ro.board.platform} ${ro.serialno}
     write /sys/kernel/boot_adsp/boot 1
 
 on boot
@@ -480,7 +481,7 @@ service p2p_supplicant /system/bin/wpa_supplicant \
     -I/system/etc/wifi/p2p_supplicant_overlay.conf -N \
     -iwlan0 -Dnl80211 -c/data/misc/wifi/wpa_supplicant.conf \
     -I/system/etc/wifi/wpa_supplicant_overlay.conf \
-    -O/data/misc/wifi/sockets -puse_p2p_group_interface=1 -dddd \
+    -O/data/misc/wifi/sockets -puse_p2p_group_interface=1 \
     -e/data/misc/wifi/entropy.bin -g@android:wpa_wlan0
 #   we will start as root and wpa_supplicant will switch to user wifi
 #   after setting up the capabilities required for WEXT
@@ -494,7 +495,7 @@ service p2p_supplicant /system/bin/wpa_supplicant \
 service wpa_supplicant /system/bin/wpa_supplicant \
     -iwlan0 -Dnl80211 -c/data/misc/wifi/wpa_supplicant.conf \
     -I/system/etc/wifi/wpa_supplicant_overlay.conf \
-    -O/data/misc/wifi/sockets -dddd \
+    -O/data/misc/wifi/sockets \
     -e/data/misc/wifi/entropy.bin -g@android:wpa_wlan0
     #   we will start as root and wpa_supplicant will switch to user wifi
     #   after setting up the capabilities required for WEXT
@@ -664,7 +665,7 @@ service atfwd /system/bin/ATFWD-daemon
     user system
     group system radio
 
-service hostapd /system/bin/hostapd -dddd /data/hostapd/hostapd.conf
+service hostapd /system/bin/hostapd -dd /data/hostapd/hostapd.conf
     class late_start
     user root
     group root
diff --git a/rootdir/etc/init.qcom.wifi.sh b/rootdir/etc/init.qcom.wifi.sh
index bc03f5c..35e008a 100644
--- a/rootdir/etc/init.qcom.wifi.sh
+++ b/rootdir/etc/init.qcom.wifi.sh
@@ -36,7 +36,7 @@
 # This script will get called after post bootup.
 
 target="$1"
-serialno="$2"
+serialno=`getprop ro.serialno`
 
 btsoc=""
 
@@ -76,15 +76,17 @@ trigger_wcnss()
             echo "No WCNSS device node detected"
             ;;
     esac
-
+    validSerial=`getprop ro.serialno | md5sum`
+    validSerial=${validSerial:0:8}
     # Plumb down the device serial number
     if [ -f /sys/devices/*wcnss-wlan/serial_number ]; then
         cd /sys/devices/*wcnss-wlan
-        echo $serialno > serial_number
+        echo $validSerial > serial_number
         cd /
     elif [ -f /sys/devices/platform/wcnss_wlan.0/serial_number ]; then
-        echo $serialno > /sys/devices/platform/wcnss_wlan.0/serial_number
+        echo $validSerial > /sys/devices/platform/wcnss_wlan.0/serial_number
     fi
+
 }
 
 
@@ -251,22 +253,22 @@ case "$target" in
       ln -s /system/lib/modules/pronto/pronto_wlan.ko \
 		/system/lib/modules/wlan.ko
       # Populate the writable driver configuration file
-      if [ ! -s /data/misc/wifi/WCNSS_qcom_cfg.ini ]; then
-          cp /system/etc/wifi/WCNSS_qcom_cfg.ini \
-		/data/misc/wifi/WCNSS_qcom_cfg.ini
-          chown -h system:wifi /data/misc/wifi/WCNSS_qcom_cfg.ini
-          chmod -h 660 /data/misc/wifi/WCNSS_qcom_cfg.ini
-      fi
+      #if [ ! -e /data/misc/wifi/WCNSS_qcom_cfg.ini ]; then
+      #    cp /system/etc/wifi/WCNSS_qcom_cfg.ini \
+	  #	/data/misc/wifi/WCNSS_qcom_cfg.ini
+      #    chown system:wifi /data/misc/wifi/WCNSS_qcom_cfg.ini
+      #    chmod 660 /data/misc/wifi/WCNSS_qcom_cfg.ini
+      #fi
 
       # The property below is used in Qcom SDK for softap to determine
       # the wifi driver config file
-      setprop wlan.driver.config /data/misc/wifi/WCNSS_qcom_cfg.ini
+      setprop wlan.driver.config /system/etc/firmware/wlan/prima/WCNSS_qcom_cfg.ini
 
       # Use different wpa_supplicant.conf template between wcn driver
       # and ath6kl driver
-      rm /system/etc/wifi/wpa_supplicant.conf
-      ln -s /system/etc/wifi/wpa_supplicant_wcn.conf \
-                /system/etc/wifi/wpa_supplicant.conf
+      #rm /system/etc/wifi/wpa_supplicant.conf
+      #ln -s /system/etc/wifi/wpa_supplicant_wcn.conf \
+       #         /system/etc/wifi/wpa_supplicant.conf
 
       # Trigger WCNSS platform driver
       trigger_wcnss &
@@ -274,17 +276,6 @@ case "$target" in
       esac
       ;;
 
-    apq8084*)
-      echo "*** Use the CNSS CLD driver.**"
-      setprop wlan.driver.ath 0
-
-      # Use different wpa_supplicant.conf template between wcn driver
-      # and ath6kl driver
-      rm /system/etc/wifi/wpa_supplicant.conf
-      ln -s /system/etc/wifi/wpa_supplicant_wcn.conf \
-                /system/etc/wifi/wpa_supplicant.conf
-    ;;
-
     msm8960*)
 
       # Move cfg80211.ko to prima directory, the default cfg80211.ko is
-- 
1.7.9.5

